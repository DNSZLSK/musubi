<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MUSUBI</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAuElEQVR4nGNgGAVDHfDL8f+nRD8jrSz7+OgjUWYT7YCUOykk+3SOyhyC5hNUQI7FpDiEidaWEzIHp8soTVzYALZ0gTcE6AGwhgC1gh4bQE8PGCFAS8uxmT/4ooAWiQ8dICfGAQ8BFnSB0H2hNLd0jsocOBslBGidALHZg+IAYspuagBke0YT4eBKhAMBMBxA64SIbv5odYw3uKlZMOGKWrwhQK30gM+cwd8qRga06BdQDOhRdA9vAABjbkwqWmLx7QAAAABJRU5ErkJggg==">
    <meta property="og:type" content="website"><meta property="og:title" content="MUSUBI"><meta property="og:description" content="A retro logic puzzle game. Fill the circles to match the numbers!"><meta property="og:image" content="https://raw.githubusercontent.com/DNSZLSK/musubi/master/Images/musubi%20logo%204.png">
    <meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="MUSUBI"><meta name="twitter:description" content="A retro logic puzzle game. Fill the circles to match the numbers!">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{background:#000;overflow:hidden;height:100vh;display:flex;justify-content:center;align-items:center;user-select:none;-webkit-tap-highlight-color:transparent}#stars-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1}#game-container{position:relative;z-index:2;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center}.screen{display:none;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;animation:fadeIn 0.3s ease-out}.screen.active{display:flex}@keyframes fadeIn{from{opacity:0}to{opacity:1}}#menu-screen{justify-content:center;gap:5px}#credits-footer{position:absolute;bottom:15px;font-family:monospace;font-size:10px;color:#333;letter-spacing:1px}#logo-img{width:650px;max-width:95%;height:auto;margin-bottom:10px;filter:drop-shadow(0 0 10px rgba(74,170,74,0.4))}body #logo-img{filter:hue-rotate(0deg) drop-shadow(0 0 10px rgba(74,170,74,0.4))}body.theme-cyan #logo-img{filter:hue-rotate(160deg) drop-shadow(0 0 10px rgba(74,170,170,0.4))}body.theme-amber #logo-img{filter:hue-rotate(-80deg) saturate(1.2) drop-shadow(0 0 10px rgba(170,136,74,0.4))}body.theme-white #logo-img{filter:saturate(0) brightness(1.3) drop-shadow(0 0 10px rgba(150,150,150,0.4))}body.theme-pink #logo-img{filter:hue-rotate(280deg) drop-shadow(0 0 10px rgba(170,74,170,0.4))}.menu-item{cursor:pointer;margin:8px 0;transition:transform 0.1s,filter 0.2s;filter:drop-shadow(0 0 2px var(--color))}.menu-item:hover{filter:drop-shadow(0 0 4px var(--color)) drop-shadow(0 0 10px var(--color))}.menu-item:active{transform:scale(0.95)}#game-screen{padding:20px;justify-content:flex-start;padding-top:80px}#top-bar{position:absolute;top:15px;left:15px;right:15px;display:flex;justify-content:space-between;align-items:center}#top-icons{display:flex;gap:15px}#top-right{display:flex;align-items:center;gap:15px}#equalizer{display:flex;align-items:flex-end;gap:3px;height:25px}#equalizer.paused .eq-bar{animation-play-state:paused;height:5px !important}.eq-bar{width:4px;background:var(--color);animation:equalize 0.8s ease-in-out infinite}.eq-bar:nth-child(1){animation-delay:0s}.eq-bar:nth-child(2){animation-delay:0.2s}.eq-bar:nth-child(3){animation-delay:0.4s}.eq-bar:nth-child(4){animation-delay:0.1s}@keyframes equalize{0%,100%{height:5px}50%{height:20px}}.top-icon{cursor:pointer;transition:filter 0.2s;filter:drop-shadow(0 0 2px var(--color))}.top-icon:hover{filter:drop-shadow(0 0 4px var(--color)) drop-shadow(0 0 10px var(--color))}#puzzle-container{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;width:100%}#puzzle-canvas{max-width:100%;filter:drop-shadow(0 0 3px var(--color))}#mode-canvas{margin-top:25px;filter:drop-shadow(0 0 5px var(--color)) drop-shadow(0 0 12px var(--color))}#timer-canvas{filter:drop-shadow(0 0 8px var(--color))}#difficulty-screen,#howto-screen,#nickname-screen,#leaderboard-screen{justify-content:space-between;padding:60px 20px 40px}.chrono-toggle{display:flex;align-items:center;gap:15px;margin:20px 0;cursor:pointer}.toggle-box{width:30px;height:30px;border:3px solid var(--color);display:flex;align-items:center;justify-content:center;transition:all 0.2s}.toggle-box.active{background:var(--color);box-shadow:0 0 10px var(--color)}.toggle-box.active::after{content:'âœ“';color:#000;font-size:18px;font-weight:bold}#nickname-screen .content,.content{display:flex;flex-direction:column;align-items:center}#nickname-input{background:transparent;border:none;outline:none;font-family:monospace;font-size:20px;color:#4a4;text-align:center;letter-spacing:3px;width:200px;margin:20px 0;padding:10px;border-bottom:2px solid #4a4}.leaderboard-nav{display:flex;align-items:center;gap:20px;margin-bottom:15px}.nav-arrow{cursor:pointer;transition:filter 0.2s,transform 0.1s;filter:drop-shadow(0 0 2px var(--color))}.nav-arrow:hover{filter:drop-shadow(0 0 6px var(--color)) drop-shadow(0 0 12px var(--color))}.nav-arrow:active{transform:scale(0.9)}body{--color:#5c5;--color-bright:#7f7}body.theme-cyan{--color:#5cc;--color-bright:#7ee}body.theme-amber{--color:#ca6;--color-bright:#ec8}body.theme-white{--color:#bbb;--color-bright:#ddd}body.theme-pink{--color:#c5c;--color-bright:#e7e}#preloader{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999}#preloader-canvas{filter:drop-shadow(0 0 8px rgba(92,204,92,0.5))}#preloader::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:repeating-linear-gradient(0deg,rgba(0,0,0,0.15),rgba(0,0,0,0.15) 1px,transparent 1px,transparent 2px);pointer-events:none;z-index:1}#preloader::after{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(92,204,92,0.03);animation:flicker 0.15s infinite;pointer-events:none;z-index:2}@keyframes flicker{0%{opacity:0.27}50%{opacity:0.26}100%{opacity:0.27}}
    </style>
</head>
<body>
    <div id="preloader"><canvas id="preloader-canvas" width="300" height="120"></canvas></div>
    <canvas id="stars-canvas"></canvas>
    <div id="game-container" style="display:none;">
        <div id="menu-screen" class="screen active">
            <img id="logo-img" src="https://raw.githubusercontent.com/DNSZLSK/musubi/master/Images/musubi%20logo%204.png" alt="MUSUBI">
            <canvas class="menu-item" id="menu-newgame" width="220" height="45"></canvas>
            <canvas class="menu-item" id="menu-leaderboard" width="280" height="45"></canvas>
            <canvas class="menu-item" id="menu-nickname" width="320" height="45"></canvas>
            <canvas class="menu-item" id="menu-howto" width="260" height="45"></canvas>
            <canvas class="menu-item" id="menu-color" width="160" height="45" style="margin-top:15px;"></canvas>
            <div id="credits-footer">Inspired by Glyn</div>
        </div>
        <div id="difficulty-screen" class="screen">
            <canvas id="diff-title" width="300" height="50"></canvas>
            <div class="content">
                <canvas class="menu-item" id="diff-training" width="340" height="45"></canvas>
                <canvas class="menu-item" id="diff-challenge" width="360" height="45"></canvas>
                <canvas class="menu-item" id="diff-expert" width="300" height="45"></canvas>
                <div class="chrono-toggle" id="chrono-toggle"><div class="toggle-box" id="chrono-box"></div><canvas id="chrono-label" width="280" height="35"></canvas></div>
                <canvas id="chrono-hint" width="340" height="25"></canvas>
            </div>
            <canvas class="menu-item" id="diff-back" width="120" height="40"></canvas>
        </div>
        <div id="game-screen" class="screen">
            <div id="top-bar">
                <div id="top-icons"><canvas class="top-icon" id="icon-stars" width="50" height="45"></canvas><canvas class="top-icon" id="icon-music" width="50" height="45"></canvas><canvas class="top-icon" id="icon-home" width="50" height="45"></canvas></div>
                <div id="top-right"><canvas id="timer-canvas" width="140" height="40" style="display:none;"></canvas><div id="equalizer" class="paused" style="cursor:pointer;"><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div></div></div>
            </div>
            <div id="puzzle-container"><canvas id="puzzle-canvas" width="340" height="340"></canvas><canvas id="mode-canvas" width="400" height="40"></canvas></div>
        </div>
        <div id="howto-screen" class="screen">
            <canvas id="howto-title" width="280" height="50"></canvas>
            <div class="content"><canvas id="howto-content" width="340" height="320"></canvas></div>
            <canvas class="menu-item" id="howto-back" width="120" height="40"></canvas>
        </div>
        <div id="nickname-screen" class="screen">
            <canvas id="nickname-title" width="320" height="50"></canvas>
            <div class="content"><input type="text" id="nickname-input" maxlength="10" placeholder="PLAYER"><canvas class="menu-item" id="nickname-save" width="120" height="40"></canvas></div>
            <canvas class="menu-item" id="nickname-back" width="120" height="40"></canvas>
        </div>
        <div id="leaderboard-screen" class="screen">
            <canvas id="leaderboard-title" width="300" height="50"></canvas>
            <div class="content">
                <div class="leaderboard-nav"><canvas class="nav-arrow" id="lb-prev" width="40" height="40"></canvas><canvas id="lb-mode-title" width="200" height="35"></canvas><canvas class="nav-arrow" id="lb-next" width="40" height="40"></canvas></div>
                <canvas id="leaderboard-list" width="380" height="380"></canvas>
            </div>
            <canvas class="menu-item" id="leaderboard-back" width="120" height="40"></canvas>
        </div>
    </div>
<script>
let starsEnabled=true,musicMuted=false,gridSize=4,circles=[],numbers=[],nickname=localStorage.getItem('musubi_nickname')||'PLAYER';
const themes=['','theme-cyan','theme-amber','theme-white','theme-pink'];
let currentTheme=0,chronoEnabled=false,chronoTime=120,chronoRemaining=0,chronoInterval=null,chronoActive=false;
const leaderboardModes=['training','challenge','expert'];
let currentLeaderboardMode=0,leaderboardData={training:[],challenge:[],expert:[]},currentScore=0,puzzlesSolved=0,animations=[];

function getColor(){return getComputedStyle(document.body).getPropertyValue('--color').trim()||'#4a4'}
function getBrightColor(){return getComputedStyle(document.body).getPropertyValue('--color-bright').trim()||'#5c5'}
function hexToRgb(hex){const r=/^#?([a-f\d]{1,2})([a-f\d]{1,2})([a-f\d]{1,2})$/i.exec(hex);return r?{r:parseInt(r[1].length===1?r[1]+r[1]:r[1],16),g:parseInt(r[2].length===1?r[2]+r[2]:r[2],16),b:parseInt(r[3].length===1?r[3]+r[3]:r[3],16)}:{r:68,g:170,b:68}}
function formatScore(n){return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,' ')}

const BLOCK_FONT={'A':["01110","10001","10001","11111","10001","10001","10001"],'B':["11110","10001","10001","11110","10001","10001","11110"],'C':["01110","10001","10000","10000","10000","10001","01110"],'D':["11110","10001","10001","10001","10001","10001","11110"],'E':["11111","10000","10000","11110","10000","10000","11111"],'F':["11111","10000","10000","11110","10000","10000","10000"],'G':["01110","10001","10000","10111","10001","10001","01110"],'H':["10001","10001","10001","11111","10001","10001","10001"],'I':["11111","00100","00100","00100","00100","00100","11111"],'J':["00111","00010","00010","00010","00010","10010","01100"],'K':["10001","10010","10100","11000","10100","10010","10001"],'L':["10000","10000","10000","10000","10000","10000","11111"],'M':["10001","11011","10101","10101","10001","10001","10001"],'N':["10001","10001","11001","10101","10011","10001","10001"],'O':["01110","10001","10001","10001","10001","10001","01110"],'P':["11110","10001","10001","11110","10000","10000","10000"],'Q':["01110","10001","10001","10001","10101","10010","01101"],'R':["11110","10001","10001","11110","10100","10010","10001"],'S':["01111","10000","10000","01110","00001","00001","11110"],'T':["11111","00100","00100","00100","00100","00100","00100"],'U':["10001","10001","10001","10001","10001","10001","01110"],'V':["10001","10001","10001","10001","10001","01010","00100"],'W':["10001","10001","10001","10101","10101","10101","01010"],'X':["10001","10001","01010","00100","01010","10001","10001"],'Y':["10001","10001","01010","00100","00100","00100","00100"],'Z':["11111","00001","00010","00100","01000","10000","11111"],'0':["01110","10001","10011","10101","11001","10001","01110"],'1':["00100","01100","00100","00100","00100","00100","01110"],'2':["01110","10001","00001","00010","00100","01000","11111"],'3':["11111","00010","00100","00010","00001","10001","01110"],'4':["00010","00110","01010","10010","11111","00010","00010"],'5':["11111","10000","11110","00001","00001","10001","01110"],'6':["00110","01000","10000","11110","10001","10001","01110"],'7':["11111","00001","00010","00100","01000","01000","01000"],'8':["01110","10001","10001","01110","10001","10001","01110"],'9':["01110","10001","10001","01111","00001","00010","01100"],' ':["00000","00000","00000","00000","00000","00000","00000"],':':["00000","00100","00100","00000","00100","00100","00000"],'-':["00000","00000","00000","11111","00000","00000","00000"],'.':["00000","00000","00000","00000","00000","01100","01100"],'<':["00010","00100","01000","10000","01000","00100","00010"],'>':["01000","00100","00010","00001","00010","00100","01000"]};

function drawScanlineText(ctx,text,x,y,ps,color){const chars=text.toUpperCase().split('');let ox=0;chars.forEach(char=>{const p=BLOCK_FONT[char]||BLOCK_FONT[' '];p.forEach((row,ri)=>{for(let c=0;c<row.length;c++){if(row[c]==='1'){for(let py=0;py<ps;py++){if(py%2===0){ctx.fillStyle=color;ctx.fillRect(x+ox+c*ps,y+ri*ps+py,ps,1)}}}}});ox+=6*ps});return ox}
function getTextWidth(text,ps){return text.length*6*ps}
function drawCenteredScanlineText(ctx,text,cw,y,ps,color){const w=getTextWidth(text,ps);drawScanlineText(ctx,text,(cw-w)/2,y,ps,color)}

const starsCanvas=document.getElementById('stars-canvas'),starsCtx=starsCanvas.getContext('2d');
const starLayers=[{stars:[],speed:0.1,size:3,count:12,alpha:0.2},{stars:[],speed:0.25,size:4,count:10,alpha:0.3},{stars:[],speed:0.5,size:5,count:8,alpha:0.45},{stars:[],speed:0.9,size:7,count:5,alpha:0.6},{stars:[],speed:1.4,size:9,count:3,alpha:0.8}];
function resizeStars(){starsCanvas.width=window.innerWidth;starsCanvas.height=window.innerHeight;initStars()}
function initStars(){starLayers.forEach(l=>{l.stars=[];for(let i=0;i<l.count;i++)l.stars.push({x:Math.random()*starsCanvas.width,y:Math.random()*starsCanvas.height})})}
resizeStars();window.addEventListener('resize',resizeStars);
function animateStars(){starsCtx.fillStyle='#000';starsCtx.fillRect(0,0,starsCanvas.width,starsCanvas.height);if(!starsEnabled){requestAnimationFrame(animateStars);return}const rgb=hexToRgb(getColor()),cx=starsCanvas.width/2,cy=starsCanvas.height/2,gz=Math.min(starsCanvas.width,starsCanvas.height)*0.3,gs=document.getElementById('game-screen'),ig=gs&&gs.classList.contains('active');starLayers.forEach(l=>{l.stars.forEach(s=>{let a=l.alpha;if(ig){const dx=s.x-cx,dy=s.y-cy,d=Math.sqrt(dx*dx+dy*dy);if(d<gz)a=l.alpha*(0.15+d/gz*0.85)}starsCtx.fillStyle=`rgba(${rgb.r},${rgb.g},${rgb.b},${a})`;starsCtx.fillRect(Math.floor(s.x),Math.floor(s.y),l.size,l.size);s.y+=l.speed;if(s.y>starsCanvas.height+l.size){s.y=-l.size*2;s.x=Math.random()*starsCanvas.width}})});requestAnimationFrame(animateStars)}
animateStars();

function drawIcon(id,type,active=true){const c=document.getElementById(id);if(!c)return;const ctx=c.getContext('2d'),color=active?getColor():'#333',w=c.width,h=c.height;ctx.clearRect(0,0,w,h);ctx.fillStyle=color;if(type==='stars'){ctx.fillRect(23,5,4,4);ctx.fillRect(19,9,12,4);ctx.fillRect(11,13,28,4);ctx.fillRect(15,17,20,4);ctx.fillRect(19,21,12,4);ctx.fillRect(15,25,8,4);ctx.fillRect(27,25,8,4);ctx.fillRect(11,29,8,4);ctx.fillRect(31,29,8,4)}else if(type==='music'){ctx.fillRect(28,6,4,24);ctx.fillRect(32,6,10,3);ctx.fillRect(32,11,8,3);ctx.fillRect(14,24,18,12)}else if(type==='home'){ctx.fillRect(23,5,4,6);ctx.fillRect(15,11,20,4);ctx.fillRect(11,15,28,4);ctx.fillRect(14,19,22,16);ctx.fillStyle='#000';ctx.fillRect(21,25,8,10)}const id2=ctx.getImageData(0,0,w,h);for(let y=0;y<h;y++){if(y%2===1){for(let x=0;x<w;x++){const i=(y*w+x)*4;id2.data[i+3]=Math.floor(id2.data[i+3]*0.3)}}}ctx.putImageData(id2,0,0)}
function drawAllIcons(){drawIcon('icon-stars','stars',starsEnabled);drawIcon('icon-music','music',!musicMuted);drawIcon('icon-home','home',true)}
function drawArrow(id,dir){const c=document.getElementById(id);if(!c)return;const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);drawCenteredScanlineText(ctx,dir==='left'?'<':'>',c.width,8,4,getColor())}

function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id+'-screen').classList.add('active');if(id==='menu')drawMenuScreen();else if(id==='difficulty')drawDifficultyScreen();else if(id==='game')drawGameScreen();else if(id==='howto')drawHowtoScreen();else if(id==='nickname')drawNicknameScreen();else if(id==='leaderboard')drawLeaderboardScreen()}

function drawMenuScreen(){const color=getColor();[['menu-newgame','NEW GAME'],['menu-leaderboard','LEADERBOARD'],['menu-nickname','YOUR NICKNAME'],['menu-howto','HOW TO PLAY'],['menu-color','COLOR']].forEach(([id,text])=>{const c=document.getElementById(id),ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);drawCenteredScanlineText(ctx,text,c.width,12,3,color)})}

function drawDifficultyScreen(){const color=getColor();const tc=document.getElementById('diff-title');tc.getContext('2d').clearRect(0,0,300,50);drawCenteredScanlineText(tc.getContext('2d'),'SELECT MODE',300,10,4,color);[['diff-training','TRAINING  4X4'],['diff-challenge','CHALLENGE  5X5'],['diff-expert','EXPERT  6X6'],['diff-back','BACK']].forEach(([id,text])=>{const c=document.getElementById(id),ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);drawCenteredScanlineText(ctx,text,c.width,12,3,color)});const cl=document.getElementById('chrono-label'),ctxL=cl.getContext('2d');ctxL.clearRect(0,0,cl.width,cl.height);drawScanlineText(ctxL,'CHRONO MODE',0,5,3,color);const ch=document.getElementById('chrono-hint'),ctxH=ch.getContext('2d');ctxH.clearRect(0,0,ch.width,ch.height);const ht=chronoEnabled?'2 MIN - SCORES COUNT':'ENABLE FOR LEADERBOARD',hc=chronoEnabled?getBrightColor():'#555';drawCenteredScanlineText(ctxH,ht,ch.width,5,2,hc);const cb=document.getElementById('chrono-box');chronoEnabled?cb.classList.add('active'):cb.classList.remove('active')}

function drawGameScreen(){drawAllIcons();drawPuzzle();const mc=document.getElementById('mode-canvas'),ctx=mc.getContext('2d');ctx.clearRect(0,0,400,40);const mn={4:'Training',5:'Challenge',6:'Expert'},dt=mn[gridSize]+'  '+formatScore(currentScore)+' PTS';drawCenteredScanlineText(ctx,dt,400,10,3,getColor());const tc=document.getElementById('timer-canvas');if(chronoEnabled){tc.style.display='block';drawTimer()}else{tc.style.display='none'}}

function drawTimer(){const tc=document.getElementById('timer-canvas'),ctx=tc.getContext('2d');ctx.clearRect(0,0,tc.width,tc.height);const m=Math.floor(chronoRemaining/60),s=chronoRemaining%60,tt=m+':'+(s<10?'0':'')+s;let color=getColor();if(chronoRemaining<=10)color='#f55';else if(chronoRemaining<=30)color='#fa5';drawCenteredScanlineText(ctx,tt,tc.width,8,4,color)}

function drawHowtoScreen(){const color=getColor();const tc=document.getElementById('howto-title');tc.getContext('2d').clearRect(0,0,280,50);drawCenteredScanlineText(tc.getContext('2d'),'HOW TO PLAY',280,10,4,color);const cc=document.getElementById('howto-content'),ctx=cc.getContext('2d');ctx.clearRect(0,0,340,320);['TAP CIRCLES TO','FILL THEM','','EACH NUMBER SHOWS','HOW MANY NEIGHBORS','ARE FILLED','','MATCH ALL NUMBERS','TO WIN'].forEach((l,i)=>{if(l)drawCenteredScanlineText(ctx,l,340,5+i*34,3,color)});const bc=document.getElementById('howto-back');bc.getContext('2d').clearRect(0,0,120,40);drawCenteredScanlineText(bc.getContext('2d'),'BACK',120,10,3,color)}

function drawNicknameScreen(){const color=getColor();const tc=document.getElementById('nickname-title');tc.getContext('2d').clearRect(0,0,320,50);drawCenteredScanlineText(tc.getContext('2d'),'YOUR NICKNAME',320,10,4,color);document.getElementById('nickname-input').style.color=color;document.getElementById('nickname-input').style.borderColor=color;document.getElementById('nickname-input').value=nickname;const sc=document.getElementById('nickname-save');sc.getContext('2d').clearRect(0,0,120,40);drawCenteredScanlineText(sc.getContext('2d'),'SAVE',120,10,3,color);const bc=document.getElementById('nickname-back');bc.getContext('2d').clearRect(0,0,120,40);drawCenteredScanlineText(bc.getContext('2d'),'BACK',120,10,3,color)}

function drawLeaderboardScreen(){const color=getColor();const tc=document.getElementById('leaderboard-title');tc.getContext('2d').clearRect(0,0,300,50);drawCenteredScanlineText(tc.getContext('2d'),'LEADERBOARD',300,10,4,color);drawArrow('lb-prev','left');drawArrow('lb-next','right');const mt=['TRAINING 4X4','CHALLENGE 5X5','EXPERT 6X6'],mc=document.getElementById('lb-mode-title'),mctx=mc.getContext('2d');mctx.clearRect(0,0,mc.width,mc.height);drawCenteredScanlineText(mctx,mt[currentLeaderboardMode],mc.width,5,3,getBrightColor());const lc=document.getElementById('leaderboard-list'),ctx=lc.getContext('2d');ctx.clearRect(0,0,380,380);drawCenteredScanlineText(ctx,'LOADING...',380,180,3,color);fetchLeaderboard().then(()=>{ctx.clearRect(0,0,380,380);const scores=leaderboardData[leaderboardModes[currentLeaderboardMode]]||[];if(scores.length===0){drawCenteredScanlineText(ctx,'NO SCORES YET',380,180,3,color)}else{scores.slice(0,10).forEach((e,i)=>{const y=15+i*36;drawScanlineText(ctx,(i+1)+'.',10,y,3,color);drawScanlineText(ctx,e.nickname,55,y,3,color);const st=formatScore(e.score),sw=getTextWidth(st,3);drawScanlineText(ctx,st,365-sw,y,3,color)})}});const bc=document.getElementById('leaderboard-back');bc.getContext('2d').clearRect(0,0,120,40);drawCenteredScanlineText(bc.getContext('2d'),'BACK',120,10,3,color)}

const LEADERBOARD_URL='https://script.google.com/macros/s/AKfycbzwwGm8kGbcjixpMpR3xhfH4gofyMPY1kXnPdcGzl4tnrJz7ewgVDH2J825Lhh93940/exec';
async function fetchLeaderboard(){try{const r=await fetch(LEADERBOARD_URL,{method:'GET',redirect:'follow'}),d=await r.json();leaderboardData.training=(d.training||[]).sort((a,b)=>b.score-a.score);leaderboardData.challenge=(d.challenge||[]).sort((a,b)=>b.score-a.score);leaderboardData.expert=(d.expert||[]).sort((a,b)=>b.score-a.score)}catch(e){console.error('Leaderboard fetch error:',e)}}
async function submitScore(score,mode){if(score<=0||!chronoEnabled)return;try{const mn={4:'training',5:'challenge',6:'expert'},p=new URLSearchParams({nickname:nickname,score:score,mode:mn[mode]||'training'}),url=LEADERBOARD_URL+'?action=submit&'+p.toString();await fetch(url,{method:'GET',redirect:'follow'})}catch(e){console.error('Score submit error:',e)}}

function startChrono(){if(!chronoEnabled)return;chronoRemaining=chronoTime;chronoActive=true;chronoInterval=setInterval(()=>{chronoRemaining--;drawTimer();if(chronoRemaining<=0)endChrono()},1000)}
function stopChrono(){if(chronoInterval){clearInterval(chronoInterval);chronoInterval=null}chronoActive=false}
function endChrono(){stopChrono();if(currentScore>0)submitScore(currentScore,gridSize);setTimeout(()=>{alert('TIME UP!\n\nScore: '+formatScore(currentScore)+' PTS\nPuzzles: '+puzzlesSolved);bgMusic.pause();bgMusic.currentTime=0;musicStarted=false;document.getElementById('equalizer').classList.add('paused');currentScore=0;puzzlesSolved=0;showScreen('menu')},100)}

function generatePuzzle(){circles=[];for(let y=0;y<gridSize;y++){circles[y]=[];for(let x=0;x<gridSize;x++)circles[y][x]={filled:false,solution:Math.random()<0.35}}numbers=[];for(let y=0;y<gridSize-1;y++){numbers[y]=[];for(let x=0;x<gridSize-1;x++){let c=0;if(circles[y][x].solution)c++;if(circles[y][x+1].solution)c++;if(circles[y+1][x].solution)c++;if(circles[y+1][x+1].solution)c++;numbers[y][x]=c}}}

function drawPuzzle(){const canvas=document.getElementById('puzzle-canvas'),ctx=canvas.getContext('2d'),color=getColor(),bc=getBrightColor(),maxS=Math.min(500,window.innerWidth-40,window.innerHeight-250),size=Math.max(280,maxS);canvas.width=size;canvas.height=size;const cs=size/gridSize,cr=cs*0.22,lw=Math.max(4,Math.floor(size/100));ctx.clearRect(0,0,size,size);ctx.fillStyle=color;for(let y=0;y<gridSize;y++){for(let x=0;x<gridSize;x++){const cx=x*cs+cs/2,cy=y*cs+cs/2;if(x<gridSize-1){const ncx=(x+1)*cs+cs/2;for(let py=0;py<lw;py++){if(py%2===0)ctx.fillRect(cx+cr,cy-lw/2+py,ncx-cx-cr*2,1)}}if(y<gridSize-1){const ncy=(y+1)*cs+cs/2;for(let px=0;px<lw;px++){if(px%2===0)ctx.fillRect(cx-lw/2+px,cy+cr,1,ncy-cy-cr*2)}}}}for(let y=0;y<gridSize-1;y++){for(let x=0;x<gridSize-1;x++){const cx=(x+1)*cs,cy=(y+1)*cs,n=numbers[y][x].toString(),tw=getTextWidth(n,4);drawScanlineText(ctx,n,cx-tw/2,cy-14,4,bc)}}for(let y=0;y<gridSize;y++){for(let x=0;x<gridSize;x++){const cx=x*cs+cs/2,cy=y*cs+cs/2,anim=animations.find(a=>a.x===x&&a.y===y);let as=1,aa=0;if(anim){const p=anim.progress;as=1+Math.sin(p*Math.PI)*0.2;aa=Math.sin(p*Math.PI)*0.6}const curr=cr*as;if(circles[y][x].filled){ctx.fillStyle=color;for(let dy=-curr;dy<=curr;dy++){if(Math.floor(cy+dy)%2===0){const w=Math.sqrt(curr*curr-dy*dy);ctx.fillRect(cx-w,cy+dy,w*2,1)}}if(aa>0){const rgb=hexToRgb(color);ctx.strokeStyle=`rgba(${rgb.r},${rgb.g},${rgb.b},${aa})`;ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,curr+8,0,Math.PI*2);ctx.stroke()}}else{ctx.fillStyle=color;const th=4;for(let t=0;t<th;t++){const r=curr-t;for(let angle=0;angle<Math.PI*2;angle+=0.03){const px=cx+Math.cos(angle)*r,py=cy+Math.sin(angle)*r;if(Math.floor(py)%2===0)ctx.fillRect(Math.floor(px),Math.floor(py),2,1)}}}}}}

function updateAnimations(){if(animations.length>0){animations.forEach(a=>a.progress+=0.08);animations=animations.filter(a=>a.progress<1);drawPuzzle()}requestAnimationFrame(updateAnimations)}
updateAnimations();
function triggerCircleAnimation(x,y){animations=animations.filter(a=>!(a.x===x&&a.y===y));animations.push({x,y,progress:0})}
function checkWin(){for(let y=0;y<gridSize-1;y++){for(let x=0;x<gridSize-1;x++){let c=0;if(circles[y][x].filled)c++;if(circles[y][x+1].filled)c++;if(circles[y+1][x].filled)c++;if(circles[y+1][x+1].filled)c++;if(c!==numbers[y][x])return false}}return true}

document.getElementById('menu-newgame').addEventListener('click',()=>showScreen('difficulty'));
document.getElementById('menu-leaderboard').addEventListener('click',()=>showScreen('leaderboard'));
document.getElementById('menu-nickname').addEventListener('click',()=>showScreen('nickname'));
document.getElementById('menu-howto').addEventListener('click',()=>showScreen('howto'));
document.getElementById('menu-color').addEventListener('click',()=>{currentTheme=(currentTheme+1)%themes.length;document.body.className=themes[currentTheme];drawMenuScreen()});
document.getElementById('diff-training').addEventListener('click',()=>startGame(4));
document.getElementById('diff-challenge').addEventListener('click',()=>startGame(5));
document.getElementById('diff-expert').addEventListener('click',()=>startGame(6));
document.getElementById('diff-back').addEventListener('click',()=>showScreen('menu'));
document.getElementById('chrono-toggle').addEventListener('click',()=>{chronoEnabled=!chronoEnabled;drawDifficultyScreen();playBeep()});
document.getElementById('lb-prev').addEventListener('click',()=>{currentLeaderboardMode=(currentLeaderboardMode-1+leaderboardModes.length)%leaderboardModes.length;drawLeaderboardScreen();playBeep()});
document.getElementById('lb-next').addEventListener('click',()=>{currentLeaderboardMode=(currentLeaderboardMode+1)%leaderboardModes.length;drawLeaderboardScreen();playBeep()});
document.getElementById('icon-home').addEventListener('click',()=>{stopChrono();if(chronoEnabled&&currentScore>0)submitScore(currentScore,gridSize);currentScore=0;puzzlesSolved=0;bgMusic.pause();bgMusic.currentTime=0;musicStarted=false;document.getElementById('equalizer').classList.add('paused');showScreen('menu')});
document.getElementById('icon-stars').addEventListener('click',()=>{starsEnabled=!starsEnabled;drawIcon('icon-stars','stars',starsEnabled)});
document.getElementById('icon-music').addEventListener('click',()=>{musicMuted=!musicMuted;bgMusic.muted=musicMuted;drawIcon('icon-music','music',!musicMuted);const eq=document.getElementById('equalizer');musicMuted?eq.classList.add('paused'):eq.classList.remove('paused')});
document.getElementById('howto-back').addEventListener('click',()=>showScreen('menu'));
const ni=document.getElementById('nickname-input');
ni.addEventListener('focus',function(){if(this.value==='PLAYER'&&nickname==='PLAYER')this.value=''});
ni.addEventListener('input',function(){this.value=this.value.replace(/[^A-Za-z0-9]/g,'').toUpperCase()});
document.getElementById('nickname-save').addEventListener('click',()=>{nickname=document.getElementById('nickname-input').value.toUpperCase()||'PLAYER';localStorage.setItem('musubi_nickname',nickname);showScreen('menu')});
document.getElementById('nickname-back').addEventListener('click',()=>showScreen('menu'));
document.getElementById('leaderboard-back').addEventListener('click',()=>showScreen('menu'));
document.getElementById('puzzle-canvas').addEventListener('click',(e)=>{const canvas=document.getElementById('puzzle-canvas'),rect=canvas.getBoundingClientRect(),sx=canvas.width/rect.width,sy=canvas.height/rect.height,x=(e.clientX-rect.left)*sx,y=(e.clientY-rect.top)*sy,cs=canvas.width/gridSize,gx=Math.floor(x/cs),gy=Math.floor(y/cs);if(gx>=0&&gx<gridSize&&gy>=0&&gy<gridSize){circles[gy][gx].filled=!circles[gy][gx].filled;triggerCircleAnimation(gx,gy);drawPuzzle();if(checkWin()){const pts=gridSize*gridSize*100;currentScore+=pts;puzzlesSolved++;const mc=document.getElementById('mode-canvas'),ctx=mc.getContext('2d');ctx.clearRect(0,0,400,40);const mn={4:'Training',5:'Challenge',6:'Expert'},dt=mn[gridSize]+'  '+formatScore(currentScore)+' PTS';drawCenteredScanlineText(ctx,dt,400,10,3,getColor());setTimeout(()=>{generatePuzzle();drawPuzzle()},500)}}});
function startGame(size){gridSize=size;currentScore=0;puzzlesSolved=0;generatePuzzle();showScreen('game');startMusicWithFade();if(chronoEnabled)startChrono()}

const musicTracks=['https://raw.githubusercontent.com/DNSZLSK/musubi/master/Music/Music1.mp3','https://raw.githubusercontent.com/DNSZLSK/musubi/master/Music/Music2.mp3','https://raw.githubusercontent.com/DNSZLSK/musubi/master/Music/Music3.mp3','https://raw.githubusercontent.com/DNSZLSK/musubi/master/Music/Music4.mp3','https://raw.githubusercontent.com/DNSZLSK/musubi/master/Music/Music5.mp3'];
let currentTrack=0;
const bgMusic=new Audio(musicTracks[0]);bgMusic.loop=false;bgMusic.volume=0.5;
bgMusic.addEventListener('ended',()=>{currentTrack=(currentTrack+1)%musicTracks.length;bgMusic.src=musicTracks[currentTrack];bgMusic.play().catch(()=>{})});
const beepSound=new Audio('https://raw.githubusercontent.com/DNSZLSK/musubi/master/Music/beepMenuChoice.mp3');beepSound.volume=0.3;
let audioContext=null,beepBuffer=null,musicStarted=false;
async function initAudioContext(){if(audioContext)return;try{audioContext=new(window.AudioContext||window.webkitAudioContext)();const r=await fetch('https://raw.githubusercontent.com/DNSZLSK/musubi/master/Music/beepMenuChoice.mp3'),ab=await r.arrayBuffer();beepBuffer=await audioContext.decodeAudioData(ab)}catch(e){}}
function playBeep(){if(audioContext&&beepBuffer){const s=audioContext.createBufferSource(),g=audioContext.createGain();g.gain.value=0.3;s.buffer=beepBuffer;s.connect(g);g.connect(audioContext.destination);s.start(0)}else{beepSound.currentTime=0;beepSound.play().catch(()=>{})}}
document.addEventListener('click',()=>initAudioContext(),{once:true});
function startMusicWithFade(){if(!musicStarted){bgMusic.volume=0;bgMusic.play().then(()=>{musicStarted=true;const eq=document.getElementById('equalizer');if(eq&&!musicMuted)eq.classList.remove('paused');let vol=0;const fi=setInterval(()=>{vol+=0.02;if(vol>=0.5){vol=0.5;clearInterval(fi)}if(!musicMuted)bgMusic.volume=vol},80)}).catch(()=>{})}}
document.getElementById('equalizer').addEventListener('click',()=>{currentTrack=(currentTrack+1)%musicTracks.length;bgMusic.src=musicTracks[currentTrack];bgMusic.play().catch(()=>{})});
document.addEventListener('click',(e)=>{if(e.target.classList.contains('menu-item')||e.target.classList.contains('top-icon')||e.target.classList.contains('nav-arrow'))playBeep()});

const preloader=document.getElementById('preloader'),preloaderCanvas=document.getElementById('preloader-canvas'),preloaderCtx=preloaderCanvas.getContext('2d'),gameContainer=document.getElementById('game-container');
const assetsToLoad=3;let loadedCount=0,preloaderDone=false,preloaderProgress=0,targetProgress=0;
function drawPreloader(){const color='#5c5',w=preloaderCanvas.width,h=preloaderCanvas.height;preloaderCtx.clearRect(0,0,w,h);drawCenteredScanlineText(preloaderCtx,'LOADING',w,15,4,color);drawCenteredScanlineText(preloaderCtx,Math.floor(preloaderProgress)+'%',w,55,3,color);const bx=30,by=85,bw=w-60,bh=16;preloaderCtx.fillStyle=color;for(let py=0;py<2;py++)if(py%2===0)preloaderCtx.fillRect(bx,by+py,bw,1);for(let py=0;py<2;py++)if(py%2===0)preloaderCtx.fillRect(bx,by+bh-2+py,bw,1);for(let px=0;px<2;px++)for(let py=0;py<bh;py++)if(py%2===0)preloaderCtx.fillRect(bx+px,by+py,1,1);for(let px=0;px<2;px++)for(let py=0;py<bh;py++)if(py%2===0)preloaderCtx.fillRect(bx+bw-2+px,by+py,1,1);const fw=Math.floor((bw-8)*(preloaderProgress/100));if(fw>0)for(let py=0;py<bh-8;py++)if(py%2===0)preloaderCtx.fillRect(bx+4,by+4+py,fw,1);if(preloaderProgress<targetProgress){preloaderProgress+=2;if(preloaderProgress>targetProgress)preloaderProgress=targetProgress}if(!preloaderDone)requestAnimationFrame(drawPreloader)}
drawPreloader();
function updateProgress(){if(preloaderDone)return;loadedCount++;targetProgress=(loadedCount/assetsToLoad)*100;if(loadedCount>=assetsToLoad){targetProgress=100;setTimeout(finishPreloader,500)}}
function finishPreloader(){if(preloaderDone)return;preloaderDone=true;preloader.style.transition='opacity 0.5s';preloader.style.opacity='0';setTimeout(()=>{preloader.style.display='none';gameContainer.style.display='flex';drawMenuScreen()},500)}
const logoImg=document.getElementById('logo-img');if(logoImg.complete)updateProgress();else{logoImg.onload=updateProgress;logoImg.onerror=updateProgress}
let musicLoaded=false;function onMusicLoad(){if(!musicLoaded){musicLoaded=true;updateProgress()}}bgMusic.oncanplaythrough=onMusicLoad;bgMusic.onloadeddata=onMusicLoad;bgMusic.onerror=onMusicLoad;
let beepLoaded=false;function onBeepLoad(){if(!beepLoaded){beepLoaded=true;updateProgress()}}beepSound.oncanplaythrough=onBeepLoad;beepSound.onloadeddata=onBeepLoad;beepSound.onerror=onBeepLoad;
setTimeout(()=>{if(!preloaderDone){targetProgress=100;setTimeout(finishPreloader,300)}},5000);
</script>
</body>
</html>